{% extends "./index.html" %} {% block body %}
<section class="content">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-lg-12 col-md-12">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h3 class="card-title">Registrar Orden</h3>
          </div>
          <div class="card-body">
            <form id="ordenForm" method="post" action="/registrarOrden/">
              {% csrf_token %}
              <div class="row">
                <!-- Cliente -->
                <div class="col-lg-4 col-md-6">
                  <div class="card card-info mb-3">
                    <div class="card-header bg-info text-white">
                      <h4 class="card-title">Registrar Cliente</h4>
                    </div>
                    <div class="card-body">
                      <div class="form-row">
                        <div class="form-group col-md-6">
                          <label for="nombre_cli" class="form-label"
                            >Nombre:</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="nombre_cli"
                            name="nombre_cli"
                            required
                          />
                        </div>
                        <div class="form-group col-md-6">
                          <label for="apellido_cli" class="form-label"
                            >Apellido:</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="apellido_cli"
                            name="apellido_cli"
                            required
                          />
                        </div>
                        <div class="form-group col-md-6">
                          <label for="ci_cli" class="form-label"
                            >Cédula:</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="ci_cli"
                            name="ci_cli"
                            required
                          />
                        </div>
                        <div class="form-group col-md-6">
                          <label for="telefono_cli" class="form-label"
                            >Teléfono:</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="telefono_cli"
                            name="telefono_cli"
                            required
                          />
                        </div>
                        <div class="form-group col-md-12">
                          <label for="email_cli" class="form-label"
                            >Correo Electrónico:</label
                          >
                          <input
                            type="email"
                            class="form-control"
                            id="email_cli"
                            name="email_cli"
                            required
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Dirección -->
                <div class="col-lg-4 col-md-6">
                  <div class="card card-success mb-3">
                    <div class="card-header bg-success text-white">
                      <h4 class="card-title">Registrar Dirección</h4>
                    </div>
                    <div class="card-body">
                      <div class="form-row">
                        <div class="form-group col-md-12">
                          <label for="ciudad_dir" class="form-label"
                            >Ciudad:</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="ciudad_dir"
                            name="ciudad_dir"
                            required
                          />
                        </div>
                        <div class="form-group col-md-12">
                          <label for="barrio_dir" class="form-label"
                            >Barrio:</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="barrio_dir"
                            name="barrio_dir"
                            required
                          />
                        </div>
                        <div class="form-group col-md-12">
                          <label for="calle_dir" class="form-label"
                            >Calle:</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="calle_dir"
                            name="calle_dir"
                            required
                          />
                        </div>
                        <div class="form-group col-md-12">
                          <label for="numero_dir" class="form-label"
                            >Número:</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="numero_dir"
                            name="numero_dir"
                            required
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Vehículo -->
                <div class="col-lg-4 col-md-6">
                  <div class="card card-warning mb-3">
                    <div class="card-header bg-warning text-white">
                      <h4 class="card-title">Registrar Vehículo</h4>
                    </div>
                    <div class="card-body">
                      <div class="form-row">
                        <div class="form-group col-md-6">
                          <label for="marca_veh" class="form-label"
                            >Marca:</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="marca_veh"
                            name="marca_veh"
                            required
                          />
                        </div>
                        <div class="form-group col-md-6">
                          <label for="modelo_veh" class="form-label"
                            >Modelo:</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="modelo_veh"
                            name="modelo_veh"
                            required
                          />
                        </div>
                        <div class="form-group col-md-6">
                          <label for="placa_veh" class="form-label"
                            >Placa:</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="placa_veh"
                            name="placa_veh"
                            required
                          />
                        </div>
                        <div class="form-group col-md-6">
                          <label for="anio_veh" class="form-label">Año:</label>
                          <input
                            type="number"
                            class="form-control"
                            id="anio_veh"
                            name="anio_veh"
                            required
                          />
                        </div>
                        <div class="form-group col-md-6">
                          <label for="chasis_veh" class="form-label"
                            >Chasis:</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="chasis_veh"
                            name="chasis_veh"
                            required
                          />
                        </div>
                        <div class="form-group col-md-6">
                          <label for="color_veh" class="form-label"
                            >Color:</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="color_veh"
                            name="color_veh"
                            required
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Orden -->
              <div class="card card-primary mb-3">
                <div class="card-header bg-primary text-white">
                  <h4 class="card-title">Registrar Orden</h4>
                </div>
                <div class="card-body">
                  <div class="form-row">
                    <div class="form-group col-md-6">
                      <label for="fecha_ord" class="form-label"
                        >Fecha de la Orden:</label
                      >
                      <input
                        type="datetime-local"
                        class="form-control"
                        id="fecha_ord"
                        name="fecha_ord"
                        readonly
                      />
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="numero_ord" class="form-label"
                      >Número de Orden:</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="numero_ord"
                      name="numero_ord"
                      value="{{ next_numero_ord }}"
                      readonly
                    />
                  </div>
                  <div class="form-group">
                    <label for="observaciones_ord" class="form-label"
                      >Observaciones:</label
                    >
                    <textarea
                      class="form-control"
                      id="observaciones_ord"
                      name="observaciones_ord"
                      rows="3"
                      required
                    ></textarea>
                  </div>
                  <div class="form-group">
                    <label for="estado_ord" class="form-label">Estado:</label>
                    <select
                      class="form-control"
                      id="estado_ord"
                      name="estado_ord"
                      required
                    >
                      {% for key, value in ESTADOS %}
                      <option value="{{ key }}">{{ value }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="usuario_id" class="form-label">Usuario:</label>
                    <select
                      class="form-control"
                      id="usuario_id"
                      name="usuario_id"
                      required
                    >
                      <option value="">Seleccione un usuario</option>
                      {% for usuario in usuarios %}
                      <option value="{{ usuario.id_usr }}">
                        {{ usuario.nombre }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
              </div>

              <!-- Servicios -->
              <div class="card card-primary mb-3">
                <div class="card-header bg-primary text-white">
                  <h4 class="card-title">Servicios</h4>
                </div>
                <div class="card-body">
                  <div class="form-group">
                    <label for="servicios" class="form-label">Servicios:</label>
                    <table class="table table-bordered">
                      <thead>
                        <tr>
                          <th>Servicio</th>
                          <th>Precio</th>
                          <th>Subtotal</th>
                          <th>Acción</th>
                        </tr>
                      </thead>
                      <tbody id="serviciosTableBody">
                        <tr>
                          <td>
                            <select
                              class="form-control"
                              name="servicio_id[]"
                              onchange="updateSubtotal(this)"
                              required
                            >
                              <option value="">Seleccione un servicio</option>
                              {% for servicio in servicios %}
                              <option
                                value="{{ servicio.id_ser }}"
                                data-precio="{{ servicio.precio_ser }}"
                              >
                                {{ servicio.nombre_ser }}
                              </option>
                              {% endfor %}
                            </select>
                          </td>
                          <td>
                            <input
                              type="text"
                              class="form-control precio"
                              readonly
                            />
                          </td>
                          <td>
                            <input
                              type="text"
                              class="form-control subtotal"
                              name="subtotal[]"
                              readonly
                            />
                          </td>
                          <td>
                            <button
                              type="button"
                              class="btn btn-danger"
                              onclick="removeRow(this)"
                            >
                              Eliminar
                            </button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                    <button
                      type="button"
                      class="btn btn-success mt-2"
                      onclick="addRow()"
                    >
                      Agregar Servicio
                    </button>
                  </div>
                  <div class="form-group">
                    <label for="total" class="form-label">Total:</label>
                    <input
                      type="text"
                      class="form-control"
                      id="total"
                      name="total"
                      readonly
                    />
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-between mt-3">
                <button type="submit" class="btn btn-primary">
                  Registrar Orden
                </button>
                <a href="{% url 'listarOrdenes' %}" class="btn btn-secondary"
                  >Cancelar</a
                >
              </div>
            </form>
          </div>
          <div class="card-footer"></div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %} {% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var fechaOrdInput = document.getElementById("fecha_ord");
    var now = new Date();
    var year = now.getFullYear();
    var month = String(now.getMonth() + 1).padStart(2, "0");
    var day = String(now.getDate()).padStart(2, "0");
    var hour = String(now.getHours()).padStart(2, "0");
    var minute = String(now.getMinutes()).padStart(2, "0");
    var localDatetime =
      year + "-" + month + "-" + day + "T" + hour + ":" + minute;
    fechaOrdInput.value = localDatetime;
  });

  function updateGasolinaLabel(value) {
    document.getElementById("nivel_gasolina_label").innerText = value + "%";
  }

  function updateSubtotal(selectElement) {
    var row = selectElement.closest("tr");
    var precio =
      selectElement.options[selectElement.selectedIndex].dataset.precio;
    var subtotalInput = row.querySelector(".subtotal");
    var precioInput = row.querySelector(".precio");

    precioInput.value = precio;
    subtotalInput.value = precio;

    updateTotal();
  }

  function updateTotal() {
    var total = 0;
    document.querySelectorAll(".subtotal").forEach(function (subtotalInput) {
      total += parseFloat(subtotalInput.value) || 0;
    });
    document.getElementById("total").value = total.toFixed(2);
  }

  function addRow() {
    var newRow = `<tr>
      <td>
        <select class="form-control" name="servicio_id[]" onchange="updateSubtotal(this)" required>
          <option value="">Seleccione un servicio</option>
          {% for servicio in servicios %}
            <option value="{{ servicio.id_ser }}" data-precio="{{ servicio.precio_ser }}">{{ servicio.nombre_ser }}</option>
          {% endfor %}
        </select>
      </td>
      <td>
        <input type="text" class="form-control precio" readonly />
      </td>
      <td>
        <input type="text" class="form-control subtotal" name="subtotal[]" readonly />
      </td>
      <td>
        <button type="button" class="btn btn-danger" onclick="removeRow(this)">Eliminar</button>
      </td>
    </tr>`;
    document
      .getElementById("serviciosTableBody")
      .insertAdjacentHTML("beforeend", newRow);
  }

  function removeRow(button) {
    button.closest("tr").remove();
    updateTotal();
  }
</script>
{% endblock %}
