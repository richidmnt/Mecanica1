{% extends "./index.html" %} {% block body %}
<section class="content">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-lg-8 col-md-10">
        <div class="card card-danger">
          <div class="card-header">
            <h3 class="card-title">Registrar Daños</h3>
          </div>
          <div class="card-body">
            <form id="daniosForm" method="post" action="/guardarDanios/">
              {% csrf_token %}
              <div class="form-group">
                <label for="" class="form-label">Elija una orden</label>
                <select name="orden" id="orden_id" class="form-control">
                  {% for orden in ordenes %}
                  <option value="{{ orden.id_ord }}">
                    {{ orden.numero_ord }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div id="carImageContainer">
                <img
                  id="carImage"
                  src="https://previews.123rf.com/images/galimovma79/galimovma791510/galimovma79151000015/47423409-veh%C3%ADculo-condici%C3%B3n-informe-coche-lista-de-verificaci%C3%B3n-el-da%C3%B1o-de-auto-vector-inspecci%C3%B3n.jpg"
                  alt="Diagrama del Vehículo"
                />
                <div id="markerContainer"></div>
              </div>
              <div class="d-flex justify-content-between mt-3">
                <button type="submit" class="btn btn-primary">
                  Guardar Daños
                </button>
                <a href="{% url 'listarDanios' %}" class="btn btn-secondary"
                  >Cancelar</a
                >
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %} {% block extra_scripts %}
<script>
  const carImage = document.getElementById("carImage");
  const markerContainer = document.getElementById("markerContainer");

  carImage.addEventListener("click", (e) => {
    const rect = carImage.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;
    addMarker(x, y);
  });

  function addMarker(x, y) {
    const marker = document.createElement("div");
    marker.className = "marker";
    marker.style.left = `${x}%`;
    marker.style.top = `${y}%`;
    marker.id = `marker-${Date.now()}`;

    const icon = document.createElement("i");
    icon.className = "fas fa-times-circle"; // Icono de X roja
    marker.appendChild(icon);

    marker.addEventListener("click", (event) => {
      event.stopPropagation();
      showCommentBox(marker, x, y);
    });
    markerContainer.appendChild(marker);
  }

  function showCommentBox(marker, x, y) {
    const existingCommentBoxes = document.querySelectorAll(".comment-box");
    existingCommentBoxes.forEach((box) => (box.style.display = "none"));

    let commentBox = marker.nextElementSibling;
    if (!commentBox || !commentBox.classList.contains("comment-box")) {
      commentBox = document.createElement("div");
      commentBox.className = "comment-box p-2";
      commentBox.style.left = `${x + 2}%`;
      commentBox.style.top = `${y}%`;
      commentBox.innerHTML = `
        <textarea class="form-control mb-2" placeholder="Describa el daño"></textarea>
        <button class="btn btn-success btn-sm mr-2" onclick="saveComment(event, this, ${x}, ${y})">Guardar</button>
        <button class="btn btn-danger btn-sm" onclick="deleteMarker('${marker.id}', this)">Eliminar</button>
      `;
      markerContainer.appendChild(commentBox);
    }
    commentBox.style.display = "block";
  }

  function saveComment(event, button, x, y) {
    event.preventDefault();
    const commentBox = button.parentElement;
    const textarea = commentBox.querySelector("textarea");
    const description = textarea.value;

    const form = document.getElementById("daniosForm");
    const inputX = document.createElement("input");
    inputX.type = "hidden";
    inputX.name = "x_pos[]";
    inputX.value = x;

    const inputY = document.createElement("input");
    inputY.type = "hidden";
    inputY.name = "y_pos[]";
    inputY.value = y;

    const inputDescription = document.createElement("input");
    inputDescription.type = "hidden";
    inputDescription.name = "descripcion_dan[]";
    inputDescription.value = description;

    form.appendChild(inputX);
    form.appendChild(inputY);
    form.appendChild(inputDescription);

    alert(`Comentario guardado: ${description}`);
    commentBox.style.display = "none";
  }

  function deleteMarker(markerId, button) {
    const commentBox = button.parentElement;
    const marker = document.getElementById(markerId);
    marker.remove();
    commentBox.remove();

    // Añadir un input oculto para marcar el marcador como eliminado
    const form = document.getElementById("daniosForm");
    const inputDeletedMarkerId = document.createElement("input");
    inputDeletedMarkerId.type = "hidden";
    inputDeletedMarkerId.name = "deleted_marker_ids[]";
    inputDeletedMarkerId.value = markerId;
    form.appendChild(inputDeletedMarkerId);
  }
</script>
{% endblock %}
